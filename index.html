<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map of RES Projects in Tunisia</title>
    <!-- Leaflet CSS for map rendering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet Geocoder for search functionality -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for a full-screen layout */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f3f4f6;
        }

        header {
            flex-shrink: 0; /* Prevent header from shrinking */
            padding: 1rem;
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
            z-index: 1000; /* Ensure header is on top */
        }

        .main-content {
            flex-grow: 1; /* Allow main content to fill remaining space */
            display: flex;
            position: relative;
        }

        /* Semi-transparent filter panel positioned over the map */
        .layers-panel {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            width: 280px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(5px);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 999; /* Below header, above map */
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: calc(100% - 3rem);
            overflow: hidden; /* Changed from auto to hidden */
            transition: padding 0.3s ease-in-out;
        }
        
        .layers-panel.collapsed {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .panel-toggle-btn {
            transition: transform 0.3s ease-in-out;
        }
        
        .layers-panel.collapsed .panel-toggle-btn {
            transform: rotate(-90deg);
        }

        .layers-content {
            max-height: 1000px; /* Large enough to not clip content */
            overflow-y: auto;
            transition: max-height 0.3s ease-in-out, margin-top 0.3s ease-in-out;
            margin-top: 1rem; /* Space between header and content */
        }
        
        .layers-panel.collapsed .layers-content {
            max-height: 0;
            margin-top: 0;
        }


        /* Map container fills the entire main content area */
        #map {
            width: 100%;
            height: 100%;
        }

        /* Custom Leaflet popup styles to match the theme */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            min-width: 250px;
        }
        .project-popup h3 {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .gemini-btn {
            margin-top: 12px;
            width: 100%;
            padding: 8px;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .gemini-btn:hover {
            background-color: #4338ca;
        }
        .gemini-insights {
            margin-top: 10px;
            padding: 10px;
            background-color: #f3f4f6;
            border-radius: 6px;
            font-size: 0.9rem;
            border-left: 3px solid #4f46e5;
        }

        /* Styles for the legend */
        .legend {
            padding: 6px 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 20px;
            color: #555;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .legend h4 {
            margin: 0 0 5px;
            color: #333;
            font-weight: bold;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
        }
        .legend .circle {
            border-radius: 50%;
            border: 1px solid #999;
        }
        .legend .line {
            height: 5px;
            border-radius: 2px;
            margin-top: 7px;
        }
        .legend .square {
            border: 1px solid #999;
        }
        
        /* Style for the search control */
        .leaflet-control-geocoder {
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        .leaflet-control-geocoder-form input {
            font-family: 'Inter', sans-serif;
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.25rem; /* from text-2xl */
            }
            header p {
                font-size: 0.875rem; /* from text-sm */
            }
            .layers-panel {
                width: auto;
                left: 1rem;
                right: 1rem;
                top: 1rem;
                padding: 1rem; /* Reduced padding */
            }
            .layers-panel h2 {
                font-size: 1.125rem; /* text-lg */
            }
            .legend {
                font-size: 12px;
                line-height: 1.5;
            }
            .legend i {
                width: 14px;
                height: 14px;
            }
            .legend .line {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="text-center">
        <h1 class="text-2xl font-bold text-gray-900">Renewable Energy Projects in Tunisia</h1>
        <p class="text-sm text-gray-600">An interactive map to visualize RES projects.</p>
    </header>

    <div class="main-content">
        <!-- Left Panel: Layers (now an overlay and collapsible) -->
        <div id="layers-panel" class="layers-panel collapsed">
            <div class="panel-header" id="panel-header">
                <h2 class="text-xl font-semibold">Layers</h2>
                <div class="panel-toggle-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
            </div>
            <div class="layers-content">
                <div id="layers" class="space-y-3 border-t pt-4 mt-2">
                    <h3 class="text-sm font-semibold text-gray-600 uppercase pt-2">Projects</h3>
                    <!-- Checkboxes for filtering by status -->
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="operational" class="form-checkbox h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400" checked>
                            <span class="ml-3 text-gray-700">Operational</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="under-construction" class="form-checkbox h-5 w-5 text-amber-500 rounded focus:ring-amber-400" checked>
                            <span class="ml-3 text-gray-700">Under Construction</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="awarded" class="form-checkbox h-5 w-5 text-blue-500 rounded focus:ring-blue-400" checked>
                            <span class="ml-3 text-gray-700">Awarded</span>
                        </label>
                    </div>

                    <h3 class="text-sm font-semibold text-gray-600 uppercase pt-2">Infrastructure</h3>
                    <!-- Checkboxes for toggling infrastructure layers -->
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="power-lines" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" checked>
                            <span class="ml-3 text-gray-700">National Grid</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="substations" class="form-checkbox h-5 w-5 text-gray-600 rounded focus:ring-gray-500" checked>
                            <span class="ml-3 text-gray-700">Posts</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map container -->
        <div id="map"></div>
    </div>

    <!-- Leaflet JavaScript for map functionality -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Geocoder script -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        const layersControl = document.getElementById('layers');
        const panelHeader = document.getElementById('panel-header');
        const layersPanel = document.getElementById('layers-panel');
        let map; // To hold the map instance
        let projectLayer, powerLinesLayer, substationsLayer, ratedLinesLayer, ratedPolygonsLayer; // Layers for map features
        let allProjectData; // To store the original project data

        // Data for the RES project points
        const projects = [
            { name: "Tozeur PV", status: "operational", capacity: "10 MW", lat: 33.91, lon: 8.13 },
            { name: "Sidi Bouzid PV", status: "operational", capacity: "10 MW", lat: 35.03, lon: 9.48 },
            { name: "Kairouan PV", status: "operational", capacity: "10 MW", lat: 35.67, lon: 10.10 },
            { name: "Tataouine PV Station", status: "operational", capacity: "10 MW", lat: 32.92, lon: 10.45 },
            { name: "Gafsa PV", status: "under-construction", capacity: "10 MW", lat: 34.42, lon: 8.78 },
            { name: "Gabes PV", status: "under-construction", capacity: "100 MW", lat: 33.88, lon: 10.11 },
            { name: "Tataouine PV", status: "awarded", capacity: "200 MW", lat: 32.95, lon: 10.50 },
            { name: "Kairouan (Methaista) PV", status: "awarded", capacity: "100 MW", lat: 35.70, lon: 10.05 },
            { name: "Gafsa (Metlaoui) PV", status: "awarded", capacity: "100 MW", lat: 34.32, lon: 8.40 },
            { name: "Sfax (Chebilia) PV", status: "awarded", capacity: "50 MW", lat: 34.74, lon: 10.76 },
            { name: "Tozeur (Ksar Ghilane) PV", status: "awarded", capacity: "50 MW", lat: 32.98, lon: 9.63 },
            { name: "Gabes (Ramada) PV", status: "awarded", capacity: "50 MW", lat: 33.70, lon: 10.38 },
            // New El-Hamma marker
            { name: "El-Hamma", status: "awarded", capacity: "100 MW", lat: 33.9, lon: 9.8 }
        ];

        // Define colors for different capacity values
        const capacityColors = {
            '10 MW': '#fee08b',
            '50 MW': '#fdae61',
            '100 MW': '#f46d43',
            '200 MW': '#d73027'
        };

        // --- NEW: Define radii for different capacity values ---
        const capacityRadii = {
            '10 MW': 6,
            '50 MW': 8,
            '100 MW': 10,
            '200 MW': 12
        };

        /**
         * Initializes the Leaflet map.
         */
        function initMap() {
            map = L.map('map').setView([34.0, 9.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Move the zoom control to the bottom left
            map.zoomControl.setPosition('bottomleft');

            // Add the geocoder control for searching
            L.Control.geocoder({
                defaultMarkGeocode: false, // Do not automatically place a marker
                placeholder: 'Search for a location...'
            })
            .on('markgeocode', function(e) {
                // When a location is found, fly to it
                const bbox = e.geocode.bbox;
                const poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]);
                map.flyToBounds(poly.getBounds());
            })
            .addTo(map);
        }

        /**
         * Binds a popup to each feature and sets up Gemini API interaction.
         */
        function onEachFeature(feature, layer) {
            if (feature.properties) {
                const props = feature.properties;
                const statusText = props.status ? props.status.charAt(0).toUpperCase() + props.status.slice(1) : 'N/A';
                const capacityText = props.capacity || 'N/A';
                const nameText = props.name || 'Unnamed Feature';
                const uniqueId = (nameText + Math.random()).replace(/[^a-zA-Z0-9]/g, '');

                const popupContent = `
                    <div class="project-popup">
                        <h3>${nameText}</h3>
                        <p><strong>Status:</strong> ${statusText}</p>
                        <p><strong>Capacity:</strong> ${capacityText}</p>
                        <div id="gemini-insights-${uniqueId}"></div>
                        <button class="gemini-btn" data-name="${nameText}" data-status="${statusText}" data-capacity="${capacityText}" data-target="gemini-insights-${uniqueId}">✨ Get Project Insights</button>
                    </div>
                `;
                layer.bindPopup(popupContent);

                // Add a click event to the layer to zoom in
                layer.on('click', (e) => {
                    // Only zoom on point features (projects, substations)
                    if (feature.geometry.type === 'Point') {
                        const latLng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                        map.flyTo(latLng, 13); // Animate zoom to level 13
                    }
                });

                layer.on('popupopen', () => {
                    const btn = document.querySelector(`.gemini-btn[data-target="gemini-insights-${uniqueId}"]`);
                    if (btn) {
                        btn.onclick = () => {
                            getProjectInsights(btn.dataset.name, btn.dataset.status, btn.dataset.capacity, btn.dataset.target);
                        };
                    }
                });
            }
        }

        /**
         * Fetches insights for a project from the Gemini API.
         */
        async function getProjectInsights(name, status, capacity, targetId) {
            const insightsContainer = document.getElementById(targetId);
            if (!insightsContainer) return;
            insightsContainer.innerHTML = `<div class="gemini-insights"><p>✨ Generating insights...</p></div>`;
            const prompt = `Provide a brief, engaging summary (about 50-70 words) for a renewable energy project in Tunisia. Name: ${name}, Status: ${status}, Capacity: ${capacity}. Focus on its potential local and national impact, and what this type of project means for Tunisia's future.`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                insightsContainer.innerHTML = `<div class="gemini-insights">${text}</div>`;
            } catch (error) {
                console.error("Gemini API Error:", error);
                insightsContainer.innerHTML = `<div class="gemini-insights"><p>Sorry, couldn't generate insights at the moment.</p></div>`;
            }
        }
        
        /**
         * Creates the project markers layer.
         */
        function createProjectMarkers() {
            allProjectData = {
                type: "FeatureCollection",
                features: projects.map(p => ({
                    type: "Feature",
                    properties: { name: p.name, status: p.status, capacity: p.capacity },
                    geometry: { type: "Point", coordinates: [p.lon, p.lat] }
                }))
            };

            projectLayer = L.geoJSON(allProjectData, {
                pointToLayer: (feature, latlng) => {
                    const capacity = feature.properties.capacity;
                    // --- UPDATED: Use dynamic radius based on capacity ---
                    return L.circleMarker(latlng, {
                        radius: capacityRadii[capacity] || 6, // Default to 6 if capacity not found
                        fillColor: capacityColors[capacity] || '#808080',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: onEachFeature
            }).addTo(map);
        }

        /**
         * Loads the power lines GeoJSON data.
         */
        async function loadPowerLinesData() {
            try {
                const geoJsonUrl = 'https://raw.githubusercontent.com/zackrouch/res_test/main/PWR_lines.geojson'; 
                const response = await fetch(geoJsonUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const powerLinesData = await response.json();

                powerLinesLayer = L.geoJSON(powerLinesData, {
                    style: { color: '#3B82F6', weight: 2, opacity: 0.7 },
                    onEachFeature: onEachFeature
                });

            } catch (error) {
                console.error("Could not load Power Lines GeoJSON data:", error);
            }
        }
        
        /**
         * Loads the substation markers GeoJSON data.
         */
        async function loadSubstationsData() {
            try {
                const geoJsonUrl = 'https://raw.githubusercontent.com/zackrouch/res_test/main/subs.geojson'; 
                const response = await fetch(geoJsonUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const substationsData = await response.json();

                substationsLayer = L.geoJSON(substationsData, {
                    pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: '#4B5563',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }),
                    onEachFeature: onEachFeature
                });

            } catch (error) {
                console.error("Could not load Substations GeoJSON data:", error);
            }
        }

        /**
         * Loads the rated lines GeoJSON data and adds it to the map.
         */
        async function loadRatedLines() {
            try {
                const geoJsonUrl = 'https://raw.githubusercontent.com/zackrouch/res_test/main/rated_lines.geojson'; 
                const response = await fetch(geoJsonUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const ratedLinesData = await response.json();

                ratedLinesLayer = L.geoJSON(ratedLinesData, {
                    style: { color: '#00BFFF', weight: 2, opacity: 0.7 }, // Deep Sky Blue
                    onEachFeature: onEachFeature
                }).addTo(map); // Add directly to map

            } catch (error) {
                console.error("Could not load Rated Lines GeoJSON data:", error);
            }
        }

        /**
         * Loads the rated polygons GeoJSON data and adds it to the map.
         */
        async function loadRatedPolygons() {
            try {
                const geoJsonUrl = 'https://raw.githubusercontent.com/zackrouch/res_test/main/rated_poly.geojson'; 
                const response = await fetch(geoJsonUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const ratedPolygonsData = await response.json();

                ratedPolygonsLayer = L.geoJSON(ratedPolygonsData, {
                    style: { color: '#4169E1', weight: 2, opacity: 0.5, fillColor: '#6495ED', fillOpacity: 0.2 }, // Royal Blue & Cornflower Blue
                    onEachFeature: onEachFeature
                }).addTo(map); // Add directly to map

            } catch (error) {
                console.error("Could not load Rated Polygons GeoJSON data:", error);
            }
        }

        /**
         * Updates visibility of layers based on selected checkboxes.
         */
        function updateLayerVisibility() {
            const checkedValues = Array.from(layersControl.querySelectorAll('input:checked')).map(input => input.value);

            // Filter Projects Layer
            if (projectLayer && allProjectData) {
                projectLayer.clearLayers();
                const filteredFeatures = allProjectData.features.filter(feature => {
                    const status = feature.properties.status.toLowerCase().replace(/\s+/g, '-');
                    return checkedValues.includes(status);
                });
                projectLayer.addData({ type: "FeatureCollection", features: filteredFeatures });
            }

            // Toggle standard layers
            const standardLayers = {
                'power-lines': powerLinesLayer,
                'substations': substationsLayer
            };

            for (const [value, layer] of Object.entries(standardLayers)) {
                if (layer) {
                    if (checkedValues.includes(value) && !map.hasLayer(layer)) {
                        map.addLayer(layer);
                    } else if (!checkedValues.includes(value) && map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                }
            }
        }
        
        /**
         * Creates and adds a legend for all data types to the map.
         */
        function addLegend() {
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const capacities = Object.keys(capacityColors);
                let labels = ['<h4>Project Capacity (MW)</h4>'];

                for (let i = 0; i < capacities.length; i++) {
                    labels.push(
                        '<i class="circle" style="background:' + capacityColors[capacities[i]] + '"></i> ' +
                        capacities[i].replace(' MW', '')
                    );
                }
                
                labels.push('<br><h4>Infrastructure</h4>');
                labels.push('<i class="line" style="background:#3B82F6"></i> National Grid');
                labels.push('<i class="circle" style="background:#4B5563"></i> Posts');


                div.innerHTML = labels.join('<br>');
                return div;
            };
            legend.addTo(map);
        }

        // Event listener for the collapsible panel
        panelHeader.addEventListener('click', () => {
            layersPanel.classList.toggle('collapsed');
        });

        // Add event listener to the layers control panel for filtering
        layersControl.addEventListener('change', updateLayerVisibility);

        // Initialize the map and load all data when the window loads
        window.onload = async () => {
            initMap();
            // Load all data layers
            createProjectMarkers();
            await loadPowerLinesData();
            await loadSubstationsData();
            await loadRatedLines(); // This will now add the layer to the map
            await loadRatedPolygons(); // This will also add the layer to the map
            addLegend();
            // Set initial visibility based on default checked boxes
            updateLayerVisibility(); 
        };
    </script>
</body>
</html>
