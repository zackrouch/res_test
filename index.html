<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map of RES Projects in Tunisia</title>
    <!-- Leaflet CSS for map rendering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Set a height for the map container */
        #map {
            height: 100%;
            min-height: 600px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Custom Leaflet popup styles to match the theme */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
        }
        .project-popup h3 {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Renewable Energy Projects in Tunisia</h1>
            <p class="text-md text-gray-600 mt-1">An interactive map to visualize project status.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Left Panel: Filters -->
            <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md self-start">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">Filters</h2>
                <div id="filters" class="space-y-3">
                    <!-- Checkboxes for filtering by status -->
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="operational" class="form-checkbox h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400" checked>
                            <span class="ml-3 text-gray-700">Operational</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="under-construction" class="form-checkbox h-5 w-5 text-amber-500 rounded focus:ring-amber-400" checked>
                            <span class="ml-3 text-gray-700">Under Construction</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="awarded" class="form-checkbox h-5 w-5 text-blue-500 rounded focus:ring-blue-400" checked>
                            <span class="ml-3 text-gray-700">Awarded</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Map -->
            <div class="md:col-span-3">
                <!-- This div will hold the Leaflet map -->
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript for map functionality -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const filters = document.getElementById('filters');
        let map; // To hold the map instance
        let geoJsonLayer; // To hold the GeoJSON layer for filtering
        let allGeoJsonData; // To store the original GeoJSON data

        // Define colors for different statuses
        const statusColors = {
            'operational': '#10B981',
            'under-construction': '#F59E0B',
            'awarded': '#3B82F6'
        };

        /**
         * Initializes the Leaflet map.
         */
        function initMap() {
            // Create a map centered on Tunisia
            map = L.map('map').setView([34.0, 9.0], 7);

            // Add the OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }

        /**
         * Styles features (lines or points) based on their 'status' property.
         * @param {object} feature - The GeoJSON feature.
         * @returns {object} - Leaflet path options for styling.
         */
        function styleFeature(feature) {
            const status = feature.properties.status ? feature.properties.status.toLowerCase().replace(/\s+/g, '-') : 'default';
            // Style for lines
            return {
                color: statusColors[status] || '#808080', // Default to gray if status is not found
                weight: 5,
                opacity: 0.8
            };
        }
        
        /**
         * Binds a popup to each feature with its properties.
         * @param {object} feature - The GeoJSON feature.
         * @param {object} layer - The Leaflet layer for the feature.
         */
        function onEachFeature(feature, layer) {
            if (feature.properties) {
                const props = feature.properties;
                // Gracefully handle missing properties
                const statusText = props.status ? props.status.charAt(0).toUpperCase() + props.status.slice(1) : 'N/A';
                const capacityText = props.capacity || 'N/A';
                const nameText = props.name || 'Unnamed Feature';

                const popupContent = `
                    <div class="project-popup">
                        <h3>${nameText}</h3>
                        <p><strong>Status:</strong> ${statusText}</p>
                        <p><strong>Capacity:</strong> ${capacityText}</p>
                    </div>
                `;
                layer.bindPopup(popupContent);
            }
        }

        /**
         * Loads GeoJSON data from a URL and adds it to the map.
         */
        async function loadGeoJsonData() {
            try {
                // *** This URL points to the raw GeoJSON file content ***
                const geoJsonUrl = 'https://raw.githubusercontent.com/zackrouch/res_test/main/PWR_lines.geojson'; 
                const response = await fetch(geoJsonUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allGeoJsonData = await response.json();

                geoJsonLayer = L.geoJSON(allGeoJsonData, {
                    // Use a single style function for all feature types (points, lines, polygons)
                    style: styleFeature,
                    // Use pointToLayer only if you want to create custom markers for points
                    pointToLayer: (feature, latlng) => {
                        // Create circle markers for point data
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: styleFeature(feature).color, // Use the color from the style function
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                // Apply initial filter after data is loaded
                filterMarkers();

            } catch (error) {
                console.error("Could not load GeoJSON data:", error);
                alert("Failed to load map data. Please check the console for more details and ensure the GeoJSON URL is correct.");
            }
        }

        /**
         * Filters markers on the map based on selected checkboxes.
         */
        function filterMarkers() {
            if (!geoJsonLayer || !allGeoJsonData) return; // Don't run if data isn't loaded

            const checkedStatuses = Array.from(filters.querySelectorAll('input:checked')).map(input => input.value);
            
            // Clear the existing layer
            geoJsonLayer.clearLayers();

            // Filter the original data and add it back to the layer
            const filteredData = allGeoJsonData.features.filter(feature => {
                // *** FIX: If a feature has no status property, always show it. ***
                if (!feature.properties.status) {
                    return true;
                }
                const status = feature.properties.status.toLowerCase().replace(/\s+/g, '-');
                return checkedStatuses.includes(status);
            });

            geoJsonLayer.addData({ type: "FeatureCollection", features: filteredData });
        }

        // Add event listener to the filter checkboxes
        filters.addEventListener('change', filterMarkers);

        // Initialize the map and load data when the window loads
        window.onload = () => {
            initMap();
            loadGeoJsonData();
        };
    </script>
</body>
</html>
